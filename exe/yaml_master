#!/usr/bin/env ruby

require "yaml_master"
require "slop"

opts = Slop.parse(strict: true) do
  on 'm', 'master=', 'master yaml file'
  on 'k', 'key=', 'single generate target key (in data: block)'
  on 'o', 'output=', 'output filename for single generate target'
  on 'a', 'all', 'target all key (defined in yaml_master: block)'
  on 'p', 'properties=', 'set property (--properties="NAME=VALUE,NAME=VALUE" or -p "NAME=VALUE" -p "NAME=VALUE")', as: Array
  on 'h', 'help', 'display this help'
  on 'v', 'verbose', 'verbose mode'
  on '--version', 'print the version' do
    puts YamlMaster::VERSION
    exit
  end
end

options = opts.to_hash

if options[:help]
  puts opts
  exit
end

unless options[:master]
  puts "--master options is necessary"
  puts opts
  exit 1
end

if options[:all].nil? && options[:key].nil?
  puts "--all or --key is necessary"
  puts opts
  exit 1
end

yaml_master = YamlMaster.new(options[:master], options[:properties] || [])

if options[:all]
  yaml_master.generate_all(verbose: options[:verbose])
else
  result = yaml_master.generate(options[:key], options[:output], {verbose: options[:verbose]})
  puts result unless options[:output]
end
